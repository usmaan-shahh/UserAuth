# Device-Based Authentication Architecture

## ðŸ—ï¸ System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT DEVICES                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   iPhone    â”‚   Desktop   â”‚    iPad     â”‚   Laptop    â”‚  More  â”‚
â”‚  (Safari)   â”‚  (Chrome)   â”‚  (Safari)   â”‚  (Firefox)  â”‚  ...   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚             â”‚             â”‚             â”‚           â”‚
       â”‚ Login       â”‚ Login       â”‚ Login       â”‚ Login     â”‚
       â”‚ Request     â”‚ Request     â”‚ Request     â”‚ Request   â”‚
       â”‚             â”‚             â”‚             â”‚           â”‚
       â–¼             â–¼             â–¼             â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API LAYER (Express)                        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              auth.routes.js                              â”‚  â”‚
â”‚  â”‚  â€¢ POST /login                                           â”‚  â”‚
â”‚  â”‚  â€¢ POST /register                                        â”‚  â”‚
â”‚  â”‚  â€¢ GET  /refresh                                         â”‚  â”‚
â”‚  â”‚  â€¢ POST /logout                                          â”‚  â”‚
â”‚  â”‚  â€¢ GET  /sessions          [Protected]                  â”‚  â”‚
â”‚  â”‚  â€¢ DELETE /sessions/:id    [Protected]                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            auth.controller.js                            â”‚  â”‚
â”‚  â”‚  â€¢ Parse device info (User-Agent)                        â”‚  â”‚
â”‚  â”‚  â€¢ Extract IP address                                    â”‚  â”‚
â”‚  â”‚  â€¢ Get geolocation                                       â”‚  â”‚
â”‚  â”‚  â€¢ Call service layer                                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BUSINESS LOGIC LAYER                         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              auth.service.js                             â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  registerUser()                                          â”‚  â”‚
â”‚  â”‚  â”œâ”€ Validate credentials                                 â”‚  â”‚
â”‚  â”‚  â”œâ”€ Hash password                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ Generate tokens                                      â”‚  â”‚
â”‚  â”‚  â””â”€ Store refresh token with device info                â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  loginUser()                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ Verify credentials                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ Check suspicious activity â—„â”€â”€â”€â”                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ Check device limit            â”‚                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ Auto-revoke oldest if needed  â”‚                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ Generate tokens               â”‚                     â”‚  â”‚
â”‚  â”‚  â””â”€ Store refresh token           â”‚                     â”‚  â”‚
â”‚  â”‚                                   â”‚                     â”‚  â”‚
â”‚  â”‚  refreshAccessToken()             â”‚                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ Verify refresh token          â”‚                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ Check if revoked              â”‚                     â”‚  â”‚
â”‚  â”‚  â”œâ”€ Update last used timestamp    â”‚                     â”‚  â”‚
â”‚  â”‚  â””â”€ Generate new access token     â”‚                     â”‚  â”‚
â”‚  â”‚                                   â”‚                     â”‚  â”‚
â”‚  â”‚  getUserSessions()                â”‚                     â”‚  â”‚
â”‚  â”‚  revokeSession()                  â”‚                     â”‚  â”‚
â”‚  â”‚  revokeAllOtherSessions()         â”‚                     â”‚  â”‚
â”‚  â”‚  revokeAllSessions()              â”‚                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚              â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚              â”‚
                        â–¼              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UTILITY LAYER                                â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            deviceParser.js          â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚
â”‚  â”‚                                                          â”‚â”‚  â”‚
â”‚  â”‚  parseDeviceInfo(userAgent)                             â”‚â”‚  â”‚
â”‚  â”‚  â”œâ”€ Parse browser, OS, device type                      â”‚â”‚  â”‚
â”‚  â”‚  â””â”€ Generate device name                                â”‚â”‚  â”‚
â”‚  â”‚                                                          â”‚â”‚  â”‚
â”‚  â”‚  getClientIp(req)                                        â”‚â”‚  â”‚
â”‚  â”‚  â””â”€ Extract IP from headers/socket                      â”‚â”‚  â”‚
â”‚  â”‚                                                          â”‚â”‚  â”‚
â”‚  â”‚  getLocationFromIp(ip)                                   â”‚â”‚  â”‚
â”‚  â”‚  â””â”€ GeoIP lookup â†’ country, city, region                â”‚â”‚  â”‚
â”‚  â”‚                                                          â”‚â”‚  â”‚
â”‚  â”‚  detectSuspiciousActivity(device, ip, previousSessions) â”‚â”‚  â”‚
â”‚  â”‚  â”œâ”€ Compare with previous sessions                      â”‚â”‚  â”‚
â”‚  â”‚  â”œâ”€ Check: new device type?                             â”‚â”‚  â”‚
â”‚  â”‚  â”œâ”€ Check: new location?                                â”‚â”‚  â”‚
â”‚  â”‚  â”œâ”€ Check: new browser?                                 â”‚â”‚  â”‚
â”‚  â”‚  â””â”€ Return: isSuspicious if 2+ factors new â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATA ACCESS LAYER                            â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            auth.repository.js                            â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  storeRefreshToken()                                     â”‚  â”‚
â”‚  â”‚  findValidRefreshToken()                                 â”‚  â”‚
â”‚  â”‚  updateRefreshTokenUsage()                               â”‚  â”‚
â”‚  â”‚  revokeRefreshToken()                                    â”‚  â”‚
â”‚  â”‚  revokeAllUserTokens()                                   â”‚  â”‚
â”‚  â”‚  getUserActiveSessions()                                 â”‚  â”‚
â”‚  â”‚  getAllUserSessions()                                    â”‚  â”‚
â”‚  â”‚  countActiveSessions()                                   â”‚  â”‚
â”‚  â”‚  findOldestActiveSession()                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE LAYER (MongoDB)                     â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   AuthUser Collection   â”‚  â”‚  RefreshToken Collection    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ â€¢ _id                   â”‚  â”‚ â€¢ _id                       â”‚  â”‚
â”‚  â”‚ â€¢ username              â”‚  â”‚ â€¢ userId (ref)              â”‚  â”‚
â”‚  â”‚ â€¢ email                 â”‚  â”‚ â€¢ tokenHash                 â”‚  â”‚
â”‚  â”‚ â€¢ password (hashed)     â”‚  â”‚ â€¢ deviceInfo                â”‚  â”‚
â”‚  â”‚ â€¢ roles                 â”‚  â”‚   - deviceName              â”‚  â”‚
â”‚  â”‚ â€¢ isEmailVerified       â”‚  â”‚   - deviceType              â”‚  â”‚
â”‚  â”‚ â€¢ createdAt             â”‚  â”‚   - browser                 â”‚  â”‚
â”‚  â”‚ â€¢ updatedAt             â”‚  â”‚   - os                      â”‚  â”‚
â”‚  â”‚                         â”‚  â”‚   - userAgent               â”‚  â”‚
â”‚  â”‚ Indexes:                â”‚  â”‚ â€¢ ipAddress                 â”‚  â”‚
â”‚  â”‚ â€¢ username (unique)     â”‚  â”‚ â€¢ location                  â”‚  â”‚
â”‚  â”‚ â€¢ email (unique,sparse) â”‚  â”‚   - country                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   - city                    â”‚  â”‚
â”‚                                â”‚   - region                  â”‚  â”‚
â”‚                                â”‚ â€¢ lastUsedAt                â”‚  â”‚
â”‚                                â”‚ â€¢ expiresAt                 â”‚  â”‚
â”‚                                â”‚ â€¢ isRevoked                 â”‚  â”‚
â”‚                                â”‚ â€¢ isSuspicious              â”‚  â”‚
â”‚                                â”‚ â€¢ suspicionReason           â”‚  â”‚
â”‚                                â”‚ â€¢ createdAt                 â”‚  â”‚
â”‚                                â”‚ â€¢ updatedAt                 â”‚  â”‚
â”‚                                â”‚                             â”‚  â”‚
â”‚                                â”‚ Indexes:                    â”‚  â”‚
â”‚                                â”‚ â€¢ userId                    â”‚  â”‚
â”‚                                â”‚ â€¢ expiresAt (TTL)           â”‚  â”‚
â”‚                                â”‚ â€¢ {userId,isRevoked}        â”‚  â”‚
â”‚                                â”‚ â€¢ {userId,createdAt}        â”‚  â”‚
â”‚                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ”„ Authentication Flow

### 1. Login Flow

```
User                Controller           Service            Repository         Database
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚â”€â”€Login Requestâ”€â”€â”€â”€â”€â”€>â”‚                   â”‚                   â”‚                 â”‚
 â”‚  (credentials,       â”‚                   â”‚                   â”‚                 â”‚
 â”‚   deviceName)        â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚â”€â”€Parse Deviceâ”€â”€â”€â”€>â”‚                   â”‚                 â”‚
 â”‚                      â”‚  Info (UA, IP)    â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚<â”€â”€Device Infoâ”€â”€â”€â”€â”€â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚â”€â”€loginUser()â”€â”€â”€â”€â”€>â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚â”€â”€Verify Credsâ”€â”€â”€â”€>â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚â”€â”€Find Userâ”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                   â”‚                   â”‚<â”€â”€User Dataâ”€â”€â”€â”€â”€â”‚
 â”‚                      â”‚                   â”‚<â”€â”€User Foundâ”€â”€â”€â”€â”€â”€â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚â”€â”€Get Previousâ”€â”€â”€â”€>â”‚                 â”‚
 â”‚                      â”‚                   â”‚  Sessions         â”‚â”€â”€Queryâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                   â”‚                   â”‚<â”€â”€Sessionsâ”€â”€â”€â”€â”€â”€â”‚
 â”‚                      â”‚                   â”‚<â”€â”€Sessionsâ”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚â”€â”€Detect Suspiciousâ”‚                 â”‚
 â”‚                      â”‚                   â”‚  Activity         â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚â”€â”€Count Activeâ”€â”€â”€â”€>â”‚                 â”‚
 â”‚                      â”‚                   â”‚  Sessions         â”‚â”€â”€Countâ”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                   â”‚                   â”‚<â”€â”€Count: 5â”€â”€â”€â”€â”€â”€â”‚
 â”‚                      â”‚                   â”‚<â”€â”€Count: 5â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚â”€â”€Revoke Oldestâ”€â”€â”€>â”‚                 â”‚
 â”‚                      â”‚                   â”‚  (if limit hit)   â”‚â”€â”€Updateâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                   â”‚                   â”‚<â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                      â”‚                   â”‚<â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚â”€â”€Generate Tokensâ”€â”€â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚â”€â”€Store Tokenâ”€â”€â”€â”€â”€>â”‚                 â”‚
 â”‚                      â”‚                   â”‚  with Device Info â”‚â”€â”€Insertâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                   â”‚                   â”‚<â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                      â”‚                   â”‚<â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚                      â”‚<â”€â”€Tokens + Warningâ”‚                   â”‚                 â”‚
 â”‚                      â”‚   (if suspicious) â”‚                   â”‚                 â”‚
 â”‚                      â”‚                   â”‚                   â”‚                 â”‚
 â”‚<â”€â”€Responseâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                   â”‚                   â”‚                 â”‚
 â”‚  (accessToken,       â”‚                   â”‚                   â”‚                 â”‚
 â”‚   warning)           â”‚                   â”‚                   â”‚                 â”‚
 â”‚  + Set Cookie        â”‚                   â”‚                   â”‚                 â”‚
 â”‚    (refreshToken)    â”‚                   â”‚                   â”‚                 â”‚
```

### 2. Refresh Token Flow

```
User              Controller         Service          Repository       Database
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚â”€â”€Refresh Requestâ”€â”€>â”‚                 â”‚                 â”‚               â”‚
 â”‚  (cookie)          â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚â”€â”€refresh()â”€â”€â”€â”€â”€>â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚â”€â”€Verify JWTâ”€â”€â”€â”€>â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚â”€â”€Find Tokenâ”€â”€â”€â”€>â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚â”€â”€Queryâ”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                    â”‚                 â”‚                 â”‚<â”€â”€Tokenâ”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                    â”‚                 â”‚<â”€â”€Tokenâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚â”€â”€Verify Hashâ”€â”€â”€â”€â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚â”€â”€Update Lastâ”€â”€â”€>â”‚               â”‚
 â”‚                    â”‚                 â”‚  Used           â”‚â”€â”€Updateâ”€â”€â”€â”€â”€â”€>â”‚
 â”‚                    â”‚                 â”‚                 â”‚<â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                    â”‚                 â”‚<â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚â”€â”€Generate Newâ”€â”€â”€â”‚               â”‚
 â”‚                    â”‚                 â”‚  Access Token   â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚<â”€â”€New Tokenâ”€â”€â”€â”€â”€â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚<â”€â”€Responseâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚                 â”‚               â”‚
 â”‚  (new accessToken) â”‚                 â”‚                 â”‚               â”‚
```

### 3. Session Management Flow

```
User              Controller         Service          Repository       Database
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚â”€â”€Get Sessionsâ”€â”€â”€â”€â”€>â”‚                 â”‚                 â”‚               â”‚
 â”‚  (Bearer token)    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚â”€â”€Verify JWTâ”€â”€â”€â”€>â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚â”€â”€getSessions()â”€>â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚â”€â”€Get Activeâ”€â”€â”€â”€>â”‚               â”‚
 â”‚                    â”‚                 â”‚  Sessions       â”‚â”€â”€Queryâ”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                    â”‚                 â”‚                 â”‚<â”€â”€Sessionsâ”€â”€â”€â”€â”‚
 â”‚                    â”‚                 â”‚<â”€â”€Sessionsâ”€â”€â”€â”€â”€â”€â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚<â”€â”€Sessionsâ”€â”€â”€â”€â”€â”€â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚<â”€â”€Responseâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚                 â”‚               â”‚
 â”‚  (session list)    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚â”€â”€Revoke Sessionâ”€â”€â”€>â”‚                 â”‚                 â”‚               â”‚
 â”‚  (sessionId)       â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚â”€â”€revoke()â”€â”€â”€â”€â”€â”€>â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚â”€â”€Revokeâ”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚â”€â”€Updateâ”€â”€â”€â”€â”€â”€>â”‚
 â”‚                    â”‚                 â”‚                 â”‚  isRevoked=true
 â”‚                    â”‚                 â”‚                 â”‚<â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                    â”‚                 â”‚<â”€â”€OKâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚                    â”‚<â”€â”€Successâ”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚               â”‚
 â”‚                    â”‚                 â”‚                 â”‚               â”‚
 â”‚<â”€â”€Responseâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                 â”‚                 â”‚               â”‚
 â”‚  (success)         â”‚                 â”‚                 â”‚               â”‚
```

---

## ðŸ” Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layer 1                         â”‚
â”‚                  HTTPS / TLS Transport                      â”‚
â”‚  â€¢ Encrypted communication                                  â”‚
â”‚  â€¢ Prevents man-in-the-middle attacks                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layer 2                         â”‚
â”‚                   Cookie Security                           â”‚
â”‚  â€¢ httpOnly: true (no JavaScript access)                    â”‚
â”‚  â€¢ secure: true (HTTPS only)                                â”‚
â”‚  â€¢ sameSite: 'None' (cross-origin protection)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layer 3                         â”‚
â”‚                   JWT Verification                          â”‚
â”‚  â€¢ Access token: 15 min expiry                              â”‚
â”‚  â€¢ Refresh token: 7 day expiry                              â”‚
â”‚  â€¢ Signed with secret keys                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layer 4                         â”‚
â”‚                   Token Hashing                             â”‚
â”‚  â€¢ Refresh tokens hashed with bcrypt                        â”‚
â”‚  â€¢ Never store plain tokens                                 â”‚
â”‚  â€¢ Salt rounds: 10                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layer 5                         â”‚
â”‚                 Device Tracking                             â”‚
â”‚  â€¢ Track device type, browser, OS                           â”‚
â”‚  â€¢ IP address logging                                       â”‚
â”‚  â€¢ Geolocation tracking                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layer 6                         â”‚
â”‚              Suspicious Activity Detection                  â”‚
â”‚  â€¢ New device type detection                                â”‚
â”‚  â€¢ New location detection                                   â”‚
â”‚  â€¢ New browser detection                                    â”‚
â”‚  â€¢ Alert user on suspicious login                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layer 7                         â”‚
â”‚                 Session Management                          â”‚
â”‚  â€¢ Device limit enforcement (max 5)                         â”‚
â”‚  â€¢ Individual session revocation                            â”‚
â”‚  â€¢ Bulk revocation (all devices)                            â”‚
â”‚  â€¢ Auto-expiration (7 days)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Security Layer 8                         â”‚
â”‚                 Database Security                           â”‚
â”‚  â€¢ TTL index for auto-cleanup                               â”‚
â”‚  â€¢ Indexed queries for performance                          â”‚
â”‚  â€¢ Atomic operations                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸ“Š Data Flow Diagram

### Token Storage & Retrieval

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   User Login     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Generate Tokens  â”‚
                    â”‚ â€¢ Access Token   â”‚
                    â”‚ â€¢ Refresh Token  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
                â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Access Token    â”‚      â”‚  Refresh Token   â”‚
    â”‚                  â”‚      â”‚                  â”‚
    â”‚ â€¢ Sent to client â”‚      â”‚ â€¢ Hash with      â”‚
    â”‚ â€¢ Stored in      â”‚      â”‚   bcrypt         â”‚
    â”‚   localStorage   â”‚      â”‚ â€¢ Store in DB    â”‚
    â”‚ â€¢ Short-lived    â”‚      â”‚   with device    â”‚
    â”‚   (15 min)       â”‚      â”‚   info           â”‚
    â”‚                  â”‚      â”‚ â€¢ Sent as cookie â”‚
    â”‚                  â”‚      â”‚ â€¢ Long-lived     â”‚
    â”‚                  â”‚      â”‚   (7 days)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                         â”‚
                â”‚                         â”‚
                â–¼                         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  API Requests    â”‚      â”‚  Token Refresh   â”‚
    â”‚                  â”‚      â”‚                  â”‚
    â”‚ â€¢ Include in     â”‚      â”‚ â€¢ Verify JWT     â”‚
    â”‚   Authorization  â”‚      â”‚ â€¢ Check hash     â”‚
    â”‚   header         â”‚      â”‚ â€¢ Check revoked  â”‚
    â”‚ â€¢ Validate       â”‚      â”‚ â€¢ Check expired  â”‚
    â”‚ â€¢ Extract userId â”‚      â”‚ â€¢ Generate new   â”‚
    â”‚                  â”‚      â”‚   access token   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ðŸŽ¯ Key Design Decisions

### 1. **Separate RefreshToken Collection**
- **Why**: Allows multiple tokens per user
- **Benefit**: Device-specific tracking and revocation

### 2. **Bcrypt Token Hashing**
- **Why**: Secure storage, can't reverse engineer
- **Benefit**: Even if DB is compromised, tokens are safe

### 3. **Device Limit (5 devices)**
- **Why**: Balance security and usability
- **Benefit**: Prevents token accumulation, auto-cleanup

### 4. **Suspicious Activity Detection**
- **Why**: Proactive security
- **Benefit**: Alert users to potential account compromise

### 5. **TTL Index on expiresAt**
- **Why**: Automatic cleanup
- **Benefit**: No manual maintenance required

### 6. **GeoIP for Location**
- **Why**: Lightweight, no external API calls
- **Benefit**: Fast, works offline, no rate limits

---

## ðŸš€ Performance Optimizations

1. **Database Indexes**
   - Fast lookups by userId
   - Efficient filtering by isRevoked
   - Quick sorting by lastUsedAt

2. **Lean Queries**
   - Use `.lean()` for read-only operations
   - Reduces memory overhead

3. **Selective Field Projection**
   - Don't return tokenHash to client
   - Reduces response size

4. **Compound Indexes**
   - `{userId, isRevoked}` for active session queries
   - `{userId, createdAt}` for session history

5. **TTL Index**
   - MongoDB handles cleanup automatically
   - No cron jobs needed

---

This architecture provides a robust, scalable, and secure multi-device authentication system! ðŸŽ‰

